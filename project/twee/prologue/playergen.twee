:: ProloguePlayerGen [nobr]

<<set $i = {}>>
<<set $i.trait_keys = []>>
<<run $i.firstname = "Robin">>
<<run $i.lastname = "Doe">>

<p>
You will be playing as a head slaver, managing a slaving company.
You should give both the player character a name, as well as the slaving company they will be managing.
From now on, the player character will simply be referred to as "you".
</p>

<div style="display: grid; grid-template-columns: auto auto 1fr; gap: 0.5em 1em; align-items: center;">
  <div>
    Your company name is
  </div>
  <<textbox "$company.player.name" $company.player.getName()>>
  <div></div>

  <div>
    Your first name is
  </div>
  <<do tag 'firstname'>>
    <<textbox "$i.firstname" $i.firstname>>
  <</do>>
  <div>
    <span class="RerollBtn">
      <<link '<i class="sfa sfa-sync-alt"></i> Male name'>>
        <<set $i.firstname = setup.generateUnitName([setup.trait.gender_male])[0]>>
        <<redo 'firstname'>>
      <</link>>
    </span>
    <span class="RerollBtn">
      <<link '<i class="sfa sfa-sync-alt"></i> Female name'>>
        <<set $i.firstname = setup.generateUnitName([setup.trait.gender_female])[0]>>
        <<redo 'firstname'>>
      <</link>>
    </span>
  </div>


  <div>
    Your last name is
  </div>
  <<do tag 'lastname'>>
    <<textbox "$i.lastname" $i.lastname>>
  <</do>>
  <div>
    <span class="RerollBtn">
      <<link '<i class="sfa sfa-sync-alt"></i> Last name'>>
        <<set $i.lastname = setup.generateUnitName([setup.trait.gender_male])[1]>>
        <<redo 'lastname'>>
      <</link>>
    </span>
  </div>
</div>

<hr/>

<p>
  To proceed, choose your player character's sex/gender:
  <br/>
  <small style="opacity: 0.6; margin-left: 0.5em;">
    <b>Tip:</b> you can hover over most stuff like the traits below, in order to see a tooltip with more information.
  </small>
</p>

<div class="Prologue-SexGenderButtons">
  <<for _key, _data range setup.SEXGENDERS>>
    <<capture _key, _data>>
      <div>
        <<button _data.name 'PrologueGenderPrefs'>>
          <<set $i.gender_key = _data.gender_trait_key>>
          <<set $i.sexgender_key = _key>>
        <</button>>
      </div>
      <span>
        <<= setup.trait[_data.gender_trait_key].rep()>>
      </span>
      <span>
        <<if _data.dick>>
          <<= setup.trait.dick_medium.rep()>>
        <<else>>
          <aside/>
        <</if>>
      </span>
      <span>
        <<if _data.vagina>>
          <<= setup.trait.vagina_loose.rep()>>
        <<else>>
          <aside/>
        <</if>>
      </span>
      <span>
        <<if _data.breast>>
          <<= setup.trait.breast_medium.rep()>>
        <<else>>
          <aside/>
        <</if>>
      </span>
    <</capture>>
  <</for>>
</div>


:: PrologueGenderPrefs [nobr]

<h3>Game Settings</h3>

<<component setup.DOM.Component.SexGenderPreferencesEditor char_creation true>>

<hr/>

<p>
  <div style="display: grid; grid-template-columns: 1fr auto; gap: 1em; align-items: center;">
    <p>
      You can configure the <b>image packs</b> you wish to be available
      to provide images to the units.
      If this is the first time you are playing this game, you can skip this.
    </p>
    <div>
      <!--<<attach setup.DOM.Menu.Settings.imagepacks()>>-->
      <<button 'Configure image packs'>>
        <<run setup.DOM.Menu.Settings.opendialog('imagepacks')>>
      <</button>>
    </div>
  </div>
</p>

<hr/>

<p>
  <div style="margin-bottom: 0.5em">
    You can choose to disable certain content (hover each for details):
    <<message '(?)'>>
      <div class='helpcard'>
        Banning a content tag means that content involving it will not be generated in your playthrough.
        For example, banning furry will cause most quests dealing specifically with furries
        to be hidden from you. You can always change this later in the game.
      </div>
    <</message>>
  </div>
  <div style="margin-left: 0.5em">
  <<include 'ShowBannedTags'>>
  </div>
</p>

<hr/>

<p>
You can <<message 'change other game settings too.'>>
<div class='helpcard'>
  <<include 'SettingsBase'>>
  </div>
<</message>>
</p>

<hr/>

<p>
<<button 'Continue' PrologueChoose>>
<</button>>
</p>


:: PrologueChoose [nobr]

<p>
You can either fully customize your player character:
<<message '(?)'>>
  <div class='helpcard'>
    Should you decide to fully customize your character, you will be asked to select
    what traits your character should have amongst the myriads of traits in the game.
    While these traits all have some in-game effects, they are all beneficial one way or another,
    and it is recommended to pick the set of traits that you simply like to roleplay as best.
  </div>
<</message>>
</p>

<p>
[[I want to fully customize myself!|PrologueRace]]
</p>

<p>
or start with a preset one:
</p>

<<rep setup.skill.combat>>-oriented
<<link 'brave desertfolk knight capable of using both arms equally well' 'PrologueGenerateChar'>>
  <<set $i.race_key = 'subrace_humandesert'>>
  <<set $i.trait_keys = [
    'bg_knight',
    'per_brave',
    'skill_ambidextrous',
  ]>>
<</link>>
<br/>
<<rep setup.skill.brawn>>-oriented
<<link 'blunt orc blacksmith with an intimidating posture' 'PrologueGenerateChar'>>
  <<set $i.race_key = 'subrace_orc'>>
  <<set $i.trait_keys = [
    'bg_metalworker',
    'per_direct',
    'skill_intimidating',
  ]>>
<</link>>
<br/>
<<rep setup.skill.survival>>-oriented
<<link 'loner dragonkin wildman capable of flight' 'PrologueGenerateChar'>>
  <<set $i.race_key = 'subrace_dragonkin'>>
  <<set $i.trait_keys = [
    'bg_wildman',
    'per_loner',
    'wings_dragonkin',
  ]>>
<</link>>
<br/>
<<rep setup.skill.intrigue>>-oriented
<<link 'sly human assassin with many connections' 'PrologueGenerateChar'>>
  <<set $i.race_key = 'subrace_humankingdom'>>
  <<set $i.trait_keys = [
    'bg_assassin',
    'per_sly',
    'skill_connected',
  ]>>
<</link>>
<br/>
<<rep setup.skill.slaving>>-oriented
<<link 'cruel engineer from a faraway land beyond the southern seas with a hypnotizing gaze' 'PrologueGenerateChar'>>
  <<set $i.race_key = 'subrace_humansea'>>
  <<set $i.trait_keys = [
    'bg_engineer',
    'per_cruel',
    'skill_hypnotic',
  ]>>
<</link>>
<br/>
<<rep setup.skill.knowledge>>-oriented
<<link 'studious northerner scholar with a creative mind' 'PrologueGenerateChar'>>
  <<set $i.race_key = 'subrace_humanvale'>>
  <<set $i.trait_keys = [
    'bg_scholar',
    'per_studious',
    'skill_creative',
  ]>>
<</link>>
<br/>
<<rep setup.skill.social>>-oriented
<<link 'silver-tongued neko noble with a divine voice' 'PrologueGenerateChar'>>
  <<set $i.race_key = 'subrace_neko'>>
  <<set $i.trait_keys = [
    'bg_noble',
    'per_gregarious',
    'skill_entertain',
  ]>>
<</link>>
<br/>
<<rep setup.skill.aid>>-oriented
<<link 'kind elven healer with vast knowledge on how to mix potions' 'PrologueGenerateChar'>>
  <<set $i.race_key = 'subrace_elf'>>
  <<set $i.trait_keys = [
    'bg_healer',
    'per_kind',
    'skill_alchemy',
  ]>>
<</link>>
<br/>
<<rep setup.skill.arcane>>-oriented
<<link 'lavish demonkin mystic gifted in the domain of the dark magic' 'PrologueGenerateChar'>>
  <<set $i.race_key = 'subrace_demonkin'>>
  <<set $i.trait_keys = [
    'bg_mystic',
    'per_lavish',
    'magic_dark',
  ]>>
<</link>>
<br/>
<<rep setup.skill.sex>>-oriented
<<link 'playful werewolf courtesan capable of communicating with animals' 'PrologueGenerateChar'>>
  <<set $i.race_key = 'subrace_werewolf'>>
  <<set $i.trait_keys = [
    'bg_courtesan',
    'per_playful',
    'skill_animal',
  ]>>
<</link>>

:: ProloguePicked [nobr]

<<message '(click to see your choices so far)'>>
  <<rep setup.trait[$i.gender_key]>>
  <<if $i.race_key>> <<rep setup.trait[$i.race_key]>> <</if>>
  <<for _itrait, _trait range $i.trait_keys>> <<rep setup.trait[_trait]>> <</for>>
<</message>>

:: PrologueRace [nobr]

You are:
<<include 'ProloguePicked'>>

<<set _data = setup.SEXGENDERS[$i.sexgender_key]>>
<<set $i.genitaltags = [_data.dick && 'dick', _data.dick && 'balls', _data.vagina && 'vagina', _data.breast && 'breast', 'anus'].filter(x => x)>>
<<set $i.genitaltags_idx = 0>>

<<for _irace, _race range setup.TraitHelper.getAllTraitsOfTags(['subrace'])>>
  <<set _ban = [
    setup.trait.subrace_demon,
    setup.trait.subrace_fairy,
    setup.trait.subrace_angel,
    setup.trait.subrace_tigerkin,
    setup.trait.subrace_dragonkin,
  ]>>
  <<if !_ban.includes(_race)>>
    <<capture _race>>
      <br/>
      <<set _text = `${setup.Article(_race.getName(), true)}`>>
      <<rep _race>>
      <<link _text>>
        <<run $i.race_key = _race.key>>
        <<goto 'PrologueGenitals'>>
      <</link>>
    <</capture>>
  <</if>>
<</for>>


:: PrologueGenitals [nobr]

You have:
<<include 'ProloguePicked'>>

<<set _tag = $i.genitaltags[$i.genitaltags_idx]>>

<<for _igenital, _genital range setup.TraitHelper.getAllTraitsOfTags([_tag])>>
  <<if _genital.getTags().includes('rare') || _genital.getTags().includes('medium') || _genital.getTags().includes('common')>>
    <<capture _genital>>
      <br/>
      <<set _text = `${setup.Article(_genital.getName(), true)}`>>
      <<rep _genital>>
      <<link _text>>
        <<run $i.trait_keys.push(_genital.key)>>
        <<set $i.genitaltags_idx += 1>>
        <<if $i.genitaltags_idx >= $i.genitaltags.length>>
          <<goto 'PrologueBg'>>
        <<else>>
          <<goto 'PrologueGenitals'>>
        <</if>>
      <</link>>:
      <<= _genital.getDescriptionDisplay()>>
    <</capture>>
  <</if>>
<</for>>


:: PrologueBg [nobr]

Before being the leader of a slaving company, you were:
<<message '(Help)'>>
  <div class='helpcard'>
    If you are confused by the number of options available, it is suggested
    to pick the background in which you are most comfortably roleplaying at.
    While background has effect on skills, it is ultimately minor and the game
    is designed to be playable with any combination of starting decisions.
  </div>
<</message>>
<<include 'ProloguePicked'>>

<<for _ibackground, _background range setup.TraitHelper.getAllTraitsOfTags(['bg'])>>
  <<if _background.getTags().includes('common') ||
       _background.getTags().includes('medium') ||
       _background.getTags().includes('rare')>>
    <<capture _background>>
      <br/>
      <<set _text = `${setup.Article(_background.getName(), true)}`>>
      <<rep _background>>
      <<link _text 'PrologueTrait'>>
        <<run $i.trait_keys.push(_background.key)>>
      <</link>>:
      <<= _background.getDescriptionDisplay()>>
    <</capture>>
  <</if>>
<</for>>

:: PrologueTrait [nobr]

Your most defining trait is that you are
(Choose one.):
<<include 'ProloguePicked'>>

<<for _itrait, _trait range setup.TraitHelper.getAllTraitsOfTags(['per'])>>
  <<if _trait.getTags().includes('common') ||
       _trait.getTags().includes('medium') ||
       _trait.getTags().includes('rare')>>
    <<if _trait != setup.trait.per_slow && _trait != setup.trait.per_smart>>
      <<capture _trait>>
        <br/>
        <<set _text = `${_trait.getName()}`>>
        <<rep _trait>>
        <<link _text 'PrologueSkill'>>
          <<run $i.trait_keys.push(_trait.key)>>
        <</link>>:
        <<= _trait.getDescriptionDisplay()>>
      <</capture>>
    <</if>>
  <</if>>
<</for>>

:: PrologueSkill [nobr]

Your are skilled in:
(Note: If you choose the
<<rep setup.trait.magic_fire>><<rep setup.trait.magic_water>><<rep setup.trait.magic_wind>><<rep setup.trait.magic_earth>><<rep setup.trait.magic_light>><<rep setup.trait.magic_dark>>
traits, they can be upgraded to a stronger version later in the game.)
<<include 'ProloguePicked'>>

<<for _itrait, _trait range setup.TraitHelper.getAllTraitsOfTags(['skill'])>>
  <<if _trait.getTags().includes('common') ||
       _trait.getTags().includes('medium') ||
       _trait.getTags().includes('rare')>>
    <<capture _trait>>
      <br/>
      <<set _text = `${_trait.getName()}`>>
      <<rep _trait>>
      <<link _text 'PrologueGenerateChar'>>
        <<run $i.trait_keys.push(_trait.key)>>
        <<if _trait == setup.trait.skill_ambidextrous && $i.race_key == 'subrace_neko'>>
          <<set $i.race_key = 'subrace_tigerkin'>>
        <</if>>
      <</link>>:
      <<= _trait.getDescriptionDisplay()>>

      <<if _trait == setup.trait.skill_ambidextrous && $i.race_key == 'subrace_neko'>>
        (Choosing this option will change your race from
        <<rep setup.trait[$i.race_key]>> to <<rep setup.trait.subrace_tigerkin>>)
      <</if>>
    <</capture>>
  <</if>>
<</for>>

<<if ['subrace_elf',
      'subrace_lizardkin',
      'subrace_demonkin',
      'subrace_humankingdom',
      'subrace_kobold',].includes($i.race_key)>>
  <br/>
  <<set _text = `${setup.trait.skill_flight.getName()}`>>
  <<rep setup.trait.skill_flight>>

  <<set _target_race = $i.race_key>>

  <<switch $i.race_key>>
  <<case 'subrace_elf'>>
    <<set _target_race = 'subrace_fairy'>>
  <<case 'subrace_lizardkin'>>
    <<set _target_race = 'subrace_dragonkin'>>
  <<case 'subrace_humankingdom'>>
    <<set _target_race = 'subrace_angel'>>
  <<case 'subrace_demonkin'>>
    <<set _target_race = 'subrace_demon'>>
  <</switch>>

  <<capture _target_race>>
    <<link _text 'PrologueGenerateChar'>>
      <<if $i.race_key == 'subrace_kobold'>>
        <<run $i.trait_keys.push('wings_dragonkin')>>
      <<else>>
        <<set $i.race_key = _target_race>>
      <</if>>
    <</link>>:
  <</capture>>
  <<= setup.trait.skill_flight.getDescriptionDisplay()>>
  <<if _target_race != $i.race_key>>
    (Choosing this option will change your race from
    <<rep setup.trait[$i.race_key]>> to <<rep setup.trait[_target_race]>>)
  <</if>>
<</if>>



:: PrologueGenerateChar [nobr]

<<set _unitgroup = setup.unitgroup[$i.race_key]>>

This is your unit:
/*
(Note that the skill focuses i.e., the three icons next to your name
like
<<rep setup.skill.combat>><<rep setup.skill.brawn>><<rep setup.skill.intrigue>>
can be changed anytime later in the game. You can also change your player's portrait later.):
*/

<<focwidget 'generatechar'>>
  <<set _unit = _unitgroup.getUnit({ gender: $i.gender_key })>>

  /* remove background and skills */
  <<run _unit.removeTraitsWithTag('bg')>>
  <<run _unit.removeTraitsWithTag('skill')>>

  <<if _unit.isHasTrait('subrace_kobold')>>
    <<run _unit.removeTraitsWithTag('wings')>>
  <</if>>

  /* add traits */
  <<for _itraitkey, _traitkey range $i.trait_keys>>
    <<run _unit.addTrait(setup.trait[_traitkey], /* trait group = */ null, /* is replace = */ true)>>
  <</for>>

  /* reset innate traits */
  <<run _unit.resetInnateTraits()>>

  /* set name */
  <<run _unit.setName($i.firstname, $i.lastname)>>

  <<replace '#genunitdiv'>>
    <<unitcard _unit>>
  <</replace>>
<</focwidget>>

<div id='genunitdiv'></div>

<<focwidget 'refreshgenerate'>>
  <<run _unit.delete()>>
  <<generatechar>>
<</focwidget>>

<<link '(regenerate unit)'>>
  <<refreshgenerate>>
<</link>>

<<link "(randomize portrait)">>
  <<run $unitimage.resetImage(_unit, true)>>
  <<replace '#genunitdiv'>>
    <<unitcard _unit>>
  <</replace>>
<</link>>

<<message '(custom portrait)'>>
  Put your image in the
  <<successtext "dist/img/customunit">> folder.
  Then, enter the filename in the text box following this.
  For example, if you put in
  <<successtextlite 'dist/img/customunit/girl.png'>> file,
  then enter in the following <<successtextlite 'girl.png'>>.
  Leave blank to use the default automatically-generated image.
  <br/>
  <<textbox "_unit.custom_image_name" _unit.custom_image_name>>
  <<link 'Apply'>>
    <<replace '#genunitdiv'>>
      <<unitcard _unit>>
    <</replace>>
  <</link>>
<</message>>

<<foctimed 0s>>
  <<generatechar>>
<</foctimed>>

<br/>
<br/>
<<button 'Proceed with this unit as your avatar' 'PrologueCompanyGenIntro'>>
  <<unset $i>>
  <<run setup.DOM.Menu.prologueMakePlayer(_unit)>>
<</button>>
